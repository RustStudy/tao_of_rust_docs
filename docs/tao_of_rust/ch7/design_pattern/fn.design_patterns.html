<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `design_patterns` fn in crate `tao_of_rust`."><meta name="keywords" content="rust, rustlang, rust-lang, design_patterns"><title>tao_of_rust::ch7::design_pattern::design_patterns - Rust</title><link rel="stylesheet" type="text/css" href="../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../dark.css"><link rel="stylesheet" type="text/css" href="../../../light.css" id="themeStyle"><script src="../../../storage.js"></script></head><body class="rustdoc fn"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><div class="sidebar-elems"><p class='location'><a href='../../index.html'>tao_of_rust</a>::<wbr><a href='../index.html'>ch7</a>::<wbr><a href='index.html'>design_pattern</a></p><script>window.sidebarCurrent = {name: 'design_patterns', ty: 'fn', relpath: ''};</script><script defer src="sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../../../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../../../theme.js"></script><nav class="sub"><form class="search-form js-only"><div class="search-container"><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><a id="settings-menu" href="../../../settings.html"><img src="../../../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class='fqn'><span class='out-of-band'><span id='render-detail'><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class='inner'>&#x2212;</span>]</a></span><a class='srclink' href='../../../src/tao_of_rust/ch7/design_pattern.rs.html#271-273' title='goto source code'>[src]</a></span><span class='in-band'>Function <a href='../../index.html'>tao_of_rust</a>::<wbr><a href='../index.html'>ch7</a>::<wbr><a href='index.html'>design_pattern</a>::<wbr><a class="fn" href=''>design_patterns</a></span></h1><pre class='rust fn'>pub fn design_patterns()</pre><div class='docblock'><h1 id="设计模式" class="section-header"><a href="#设计模式">设计模式</a></h1>
<p>Base usage: 建造者模式</p>
<p>Rust常用设计模式之一，标准库中std::process::Command就是典型</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">struct</span> <span class="ident">Circle</span> {
    <span class="ident">x</span>: <span class="ident">f64</span>,
    <span class="ident">y</span>: <span class="ident">f64</span>,
    <span class="ident">radius</span>: <span class="ident">f64</span>,
}
<span class="kw">struct</span> <span class="ident">CircleBuilder</span> {
    <span class="ident">x</span>: <span class="ident">f64</span>,
    <span class="ident">y</span>: <span class="ident">f64</span>,
    <span class="ident">radius</span>: <span class="ident">f64</span>,
}
<span class="kw">impl</span> <span class="ident">Circle</span> {
    <span class="kw">fn</span> <span class="ident">area</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="ident">f64</span> {
        <span class="ident">std</span>::<span class="ident">f64</span>::<span class="ident">consts</span>::<span class="ident">PI</span> <span class="op">*</span> (<span class="self">self</span>.<span class="ident">radius</span> <span class="op">*</span> <span class="self">self</span>.<span class="ident">radius</span>)
    }
    <span class="kw">fn</span> <span class="ident">new</span>() <span class="op">-&gt;</span> <span class="ident">CircleBuilder</span> {
        <span class="ident">CircleBuilder</span> {
            <span class="ident">x</span>: <span class="number">0.0</span>, <span class="ident">y</span>: <span class="number">0.0</span>, <span class="ident">radius</span>: <span class="number">1.0</span>,
        }
   }
}
<span class="kw">impl</span> <span class="ident">CircleBuilder</span> {
   <span class="kw">fn</span> <span class="ident">x</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">coordinate</span>: <span class="ident">f64</span>) <span class="op">-&gt;</span> <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">CircleBuilder</span> {
       <span class="self">self</span>.<span class="ident">x</span> <span class="op">=</span> <span class="ident">coordinate</span>;
       <span class="self">self</span>
   }
   <span class="kw">fn</span> <span class="ident">y</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">coordinate</span>: <span class="ident">f64</span>) <span class="op">-&gt;</span> <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">CircleBuilder</span> {
       <span class="self">self</span>.<span class="ident">y</span> <span class="op">=</span> <span class="ident">coordinate</span>;
       <span class="self">self</span>
   }
   <span class="kw">fn</span> <span class="ident">radius</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">radius</span>: <span class="ident">f64</span>) <span class="op">-&gt;</span> <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">CircleBuilder</span> {
       <span class="self">self</span>.<span class="ident">radius</span> <span class="op">=</span> <span class="ident">radius</span>;
      <span class="self">self</span>
   }
   <span class="kw">fn</span> <span class="ident">build</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="ident">Circle</span> {
       <span class="ident">Circle</span> {
           <span class="ident">x</span>: <span class="self">self</span>.<span class="ident">x</span>, <span class="ident">y</span>: <span class="self">self</span>.<span class="ident">y</span>, <span class="ident">radius</span>: <span class="self">self</span>.<span class="ident">radius</span>,
       }
   }
}
<span class="kw">fn</span> <span class="ident">main</span>() {
   <span class="kw">let</span> <span class="ident">c</span> <span class="op">=</span> <span class="ident">Circle</span>::<span class="ident">new</span>()
            .<span class="ident">x</span>(<span class="number">1.0</span>).<span class="ident">y</span>(<span class="number">2.0</span>).<span class="ident">radius</span>(<span class="number">2.0</span>)
            . <span class="ident">build</span>();
   <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="ident">c</span>.<span class="ident">area</span>(), <span class="number">12.566370614359172</span>); <span class="comment">// 可能不同机器的值有所差异</span>
   <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="ident">c</span>.<span class="ident">x</span>, <span class="number">1.0</span>);
   <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="ident">c</span>.<span class="ident">y</span>, <span class="number">2.0</span>);
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Ballow(unused)%5D%0Astruct%20Circle%20%7B%0A%20%20%20%20x%3A%20f64%2C%0A%20%20%20%20y%3A%20f64%2C%0A%20%20%20%20radius%3A%20f64%2C%0A%7D%0Astruct%20CircleBuilder%20%7B%0A%20%20%20%20x%3A%20f64%2C%0A%20%20%20%20y%3A%20f64%2C%0A%20%20%20%20radius%3A%20f64%2C%0A%7D%0Aimpl%20Circle%20%7B%0A%20%20%20%20fn%20area(%26self)%20-%3E%20f64%20%7B%0A%20%20%20%20%20%20%20%20std%3A%3Af64%3A%3Aconsts%3A%3API%20*%20(self.radius%20*%20self.radius)%0A%20%20%20%20%7D%0A%20%20%20%20fn%20new()%20-%3E%20CircleBuilder%20%7B%0A%20%20%20%20%20%20%20%20CircleBuilder%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3A%200.0%2C%20y%3A%200.0%2C%20radius%3A%201.0%2C%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%7D%0A%7D%0Aimpl%20CircleBuilder%20%7B%0A%20%20%20fn%20x(%26mut%20self%2C%20coordinate%3A%20f64)%20-%3E%20%26mut%20CircleBuilder%20%7B%0A%20%20%20%20%20%20%20self.x%20%3D%20coordinate%3B%0A%20%20%20%20%20%20%20self%0A%20%20%20%7D%0A%20%20%20fn%20y(%26mut%20self%2C%20coordinate%3A%20f64)%20-%3E%20%26mut%20CircleBuilder%20%7B%0A%20%20%20%20%20%20%20self.y%20%3D%20coordinate%3B%0A%20%20%20%20%20%20%20self%0A%20%20%20%7D%0A%20%20%20fn%20radius(%26mut%20self%2C%20radius%3A%20f64)%20-%3E%20%26mut%20CircleBuilder%20%7B%0A%20%20%20%20%20%20%20self.radius%20%3D%20radius%3B%0A%20%20%20%20%20%20self%0A%20%20%20%7D%0A%20%20%20fn%20build(%26self)%20-%3E%20Circle%20%7B%0A%20%20%20%20%20%20%20Circle%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20x%3A%20self.x%2C%20y%3A%20self.y%2C%20radius%3A%20self.radius%2C%0A%20%20%20%20%20%20%20%7D%0A%20%20%20%7D%0A%7D%0Afn%20main()%20%7B%0A%20%20%20let%20c%20%3D%20Circle%3A%3Anew()%0A%20%20%20%20%20%20%20%20%20%20%20%20.x(1.0).y(2.0).radius(2.0)%0A%20%20%20%20%20%20%20%20%20%20%20%20.%20build()%3B%0A%20%20%20assert_eq!(c.area()%2C%2012.566370614359172)%3B%20%2F%2F%20%E5%8F%AF%E8%83%BD%E4%B8%8D%E5%90%8C%E6%9C%BA%E5%99%A8%E7%9A%84%E5%80%BC%E6%9C%89%E6%89%80%E5%B7%AE%E5%BC%82%0A%20%20%20assert_eq!(c.x%2C%201.0)%3B%0A%20%20%20assert_eq!(c.y%2C%202.0)%3B%0A%7D">Run</a></pre></div>
<p>Base usage: 访问者模式</p>
<p>Rust源码中还包含两个案例：</p>
<ol>
<li>rustc编译器源码中AST处理</li>
<li>Serde的架构是访问者模式</li>
</ol>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">any</span>::<span class="ident">Any</span>;
<span class="kw">trait</span> <span class="ident">HouseElement</span> {
    <span class="kw">fn</span> <span class="ident">accept</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">visitor</span>: <span class="kw-2">&amp;</span><span class="ident">HouseElementVisitor</span>);
    <span class="kw">fn</span> <span class="ident">as_any</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="kw-2">&amp;</span><span class="ident">Any</span>;
}
<span class="kw">trait</span> <span class="ident">HouseElementVisitor</span> {
    <span class="kw">fn</span> <span class="ident">visit</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">element</span>: <span class="kw-2">&amp;</span><span class="ident">HouseElement</span>);
}
<span class="kw">struct</span> <span class="ident">House</span> {
    <span class="ident">components</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Box</span><span class="op">&lt;</span><span class="ident">HouseElement</span><span class="op">&gt;&gt;</span>,
}
<span class="kw">impl</span> <span class="ident">House</span> {
    <span class="kw">fn</span> <span class="ident">new</span>() <span class="op">-&gt;</span> <span class="self">Self</span> {
        <span class="ident">House</span> {
            <span class="ident">components</span>: <span class="macro">vec</span><span class="macro">!</span>[<span class="ident">Box</span>::<span class="ident">new</span>(<span class="ident">Livingroom</span>::<span class="ident">new</span>())],
        }
    }
}
<span class="kw">impl</span> <span class="ident">HouseElement</span> <span class="kw">for</span> <span class="ident">House</span> {
    <span class="kw">fn</span> <span class="ident">accept</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">visitor</span>: <span class="kw-2">&amp;</span><span class="ident">HouseElementVisitor</span>) {
        <span class="kw">for</span> <span class="ident">component</span> <span class="kw">in</span> <span class="self">self</span>.<span class="ident">components</span>.<span class="ident">iter</span>() {
            <span class="ident">component</span>.<span class="ident">accept</span>(<span class="ident">visitor</span>);
        }
        <span class="ident">visitor</span>.<span class="ident">visit</span>(<span class="self">self</span>);
    }
    <span class="kw">fn</span> <span class="ident">as_any</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="kw-2">&amp;</span><span class="ident">Any</span> { <span class="self">self</span> }
}

<span class="kw">struct</span> <span class="ident">Livingroom</span>;
<span class="kw">impl</span> <span class="ident">Livingroom</span> {
    <span class="kw">fn</span> <span class="ident">new</span>() <span class="op">-&gt;</span> <span class="self">Self</span> { <span class="ident">Livingroom</span> }
}
<span class="kw">impl</span> <span class="ident">HouseElement</span> <span class="kw">for</span> <span class="ident">Livingroom</span> {
    <span class="kw">fn</span> <span class="ident">accept</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">visitor</span>: <span class="kw-2">&amp;</span><span class="ident">HouseElementVisitor</span>) {
        <span class="ident">visitor</span>.<span class="ident">visit</span>(<span class="self">self</span>);
    }
    <span class="kw">fn</span> <span class="ident">as_any</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="kw-2">&amp;</span><span class="ident">Any</span> { <span class="self">self</span> }
}

<span class="kw">struct</span> <span class="ident">HouseElementListVisitor</span>;
<span class="kw">impl</span> <span class="ident">HouseElementListVisitor</span> {
    <span class="kw">fn</span> <span class="ident">new</span>() <span class="op">-&gt;</span> <span class="self">Self</span> { <span class="ident">HouseElementListVisitor</span> }
}

<span class="kw">impl</span> <span class="ident">HouseElementVisitor</span> <span class="kw">for</span>  <span class="ident">HouseElementListVisitor</span> {
    <span class="kw">fn</span> <span class="ident">visit</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">element</span>: <span class="kw-2">&amp;</span><span class="ident">HouseElement</span>) {
        <span class="kw">match</span> <span class="ident">element</span>.<span class="ident">as_any</span>() {
            <span class="ident">house</span> <span class="kw">if</span> <span class="ident">house</span>.<span class="ident">is</span>::<span class="op">&lt;</span><span class="ident">House</span><span class="op">&gt;</span>() <span class="op">=&gt;</span> <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;Visiting the house...&quot;</span>),
            <span class="ident">living</span> <span class="kw">if</span> <span class="ident">living</span>.<span class="ident">is</span>::<span class="op">&lt;</span><span class="ident">Livingroom</span><span class="op">&gt;</span>() <span class="op">=&gt;</span> <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;Visiting the Living room...&quot;</span>),
            <span class="kw">_</span> <span class="op">=&gt;</span> {}
        }
    }
}
<span class="kw">struct</span> <span class="ident">HouseElementDemolishVisitor</span>;
<span class="kw">impl</span> <span class="ident">HouseElementDemolishVisitor</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">new</span>() <span class="op">-&gt;</span> <span class="self">Self</span> {
        <span class="ident">HouseElementDemolishVisitor</span>
    }
}
<span class="kw">impl</span> <span class="ident">HouseElementVisitor</span> <span class="kw">for</span> <span class="ident">HouseElementDemolishVisitor</span> {
    <span class="kw">fn</span> <span class="ident">visit</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">element</span>: <span class="kw-2">&amp;</span><span class="ident">HouseElement</span>) {
        <span class="kw">match</span> <span class="ident">element</span>.<span class="ident">as_any</span>() {
            <span class="ident">house</span> <span class="kw">if</span> <span class="ident">house</span>.<span class="ident">is</span>::<span class="op">&lt;</span><span class="ident">House</span><span class="op">&gt;</span>() <span class="op">=&gt;</span> <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;Annihilating the house...!!!&quot;</span>),
            <span class="ident">living</span> <span class="kw">if</span> <span class="ident">living</span>.<span class="ident">is</span>::<span class="op">&lt;</span><span class="ident">Livingroom</span><span class="op">&gt;</span>() <span class="op">=&gt;</span> <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;Bombing the Living room...!!!&quot;</span>),
            <span class="kw">_</span> <span class="op">=&gt;</span> {}
        }
    }
}

<span class="kw">fn</span> <span class="ident">main</span>() {
    <span class="kw">let</span> <span class="ident">house</span> <span class="op">=</span> <span class="ident">House</span>::<span class="ident">new</span>();
    <span class="comment">// simply print out the house elements</span>
    <span class="ident">house</span>.<span class="ident">accept</span>(<span class="kw-2">&amp;</span><span class="ident">HouseElementListVisitor</span>::<span class="ident">new</span>());
    <span class="macro">println</span><span class="macro">!</span>();
    <span class="comment">// do something with the elements of a house</span>
    <span class="ident">house</span>.<span class="ident">accept</span>(<span class="kw-2">&amp;</span><span class="ident">HouseElementDemolishVisitor</span>::<span class="ident">new</span>());
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Ballow(unused)%5D%0Ause%20std%3A%3Aany%3A%3AAny%3B%0Atrait%20HouseElement%20%7B%0A%20%20%20%20fn%20accept(%26self%2C%20visitor%3A%20%26HouseElementVisitor)%3B%0A%20%20%20%20fn%20as_any(%26self)%20-%3E%20%26Any%3B%0A%7D%0Atrait%20HouseElementVisitor%20%7B%0A%20%20%20%20fn%20visit(%26self%2C%20element%3A%20%26HouseElement)%3B%0A%7D%0Astruct%20House%20%7B%0A%20%20%20%20components%3A%20Vec%3CBox%3CHouseElement%3E%3E%2C%0A%7D%0Aimpl%20House%20%7B%0A%20%20%20%20fn%20new()%20-%3E%20Self%20%7B%0A%20%20%20%20%20%20%20%20House%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20components%3A%20vec!%5BBox%3A%3Anew(Livingroom%3A%3Anew())%5D%2C%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0Aimpl%20HouseElement%20for%20House%20%7B%0A%20%20%20%20fn%20accept(%26self%2C%20visitor%3A%20%26HouseElementVisitor)%20%7B%0A%20%20%20%20%20%20%20%20for%20component%20in%20self.components.iter()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20component.accept(visitor)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20visitor.visit(self)%3B%0A%20%20%20%20%7D%0A%20%20%20%20fn%20as_any(%26self)%20-%3E%20%26Any%20%7B%20self%20%7D%0A%7D%0A%0Astruct%20Livingroom%3B%0Aimpl%20Livingroom%20%7B%0A%20%20%20%20fn%20new()%20-%3E%20Self%20%7B%20Livingroom%20%7D%0A%7D%0Aimpl%20HouseElement%20for%20Livingroom%20%7B%0A%20%20%20%20fn%20accept(%26self%2C%20visitor%3A%20%26HouseElementVisitor)%20%7B%0A%20%20%20%20%20%20%20%20visitor.visit(self)%3B%0A%20%20%20%20%7D%0A%20%20%20%20fn%20as_any(%26self)%20-%3E%20%26Any%20%7B%20self%20%7D%0A%7D%0A%0Astruct%20HouseElementListVisitor%3B%0Aimpl%20HouseElementListVisitor%20%7B%0A%20%20%20%20fn%20new()%20-%3E%20Self%20%7B%20HouseElementListVisitor%20%7D%0A%7D%0A%0Aimpl%20HouseElementVisitor%20for%20%20HouseElementListVisitor%20%7B%0A%20%20%20%20fn%20visit(%26self%2C%20element%3A%20%26HouseElement)%20%7B%0A%20%20%20%20%20%20%20%20match%20element.as_any()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20house%20if%20house.is%3A%3A%3CHouse%3E()%20%3D%3E%20println!(%22Visiting%20the%20house...%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20living%20if%20living.is%3A%3A%3CLivingroom%3E()%20%3D%3E%20println!(%22Visiting%20the%20Living%20room...%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20_%20%3D%3E%20%7B%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0Astruct%20HouseElementDemolishVisitor%3B%0Aimpl%20HouseElementDemolishVisitor%20%7B%0A%20%20%20%20pub%20fn%20new()%20-%3E%20Self%20%7B%0A%20%20%20%20%20%20%20%20HouseElementDemolishVisitor%0A%20%20%20%20%7D%0A%7D%0Aimpl%20HouseElementVisitor%20for%20HouseElementDemolishVisitor%20%7B%0A%20%20%20%20fn%20visit(%26self%2C%20element%3A%20%26HouseElement)%20%7B%0A%20%20%20%20%20%20%20%20match%20element.as_any()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20house%20if%20house.is%3A%3A%3CHouse%3E()%20%3D%3E%20println!(%22Annihilating%20the%20house...!!!%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20living%20if%20living.is%3A%3A%3CLivingroom%3E()%20%3D%3E%20println!(%22Bombing%20the%20Living%20room...!!!%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20_%20%3D%3E%20%7B%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0Afn%20main()%20%7B%0A%20%20%20%20let%20house%20%3D%20House%3A%3Anew()%3B%0A%20%20%20%20%2F%2F%20simply%20print%20out%20the%20house%20elements%0A%20%20%20%20house.accept(%26HouseElementListVisitor%3A%3Anew())%3B%0A%20%20%20%20println!()%3B%0A%20%20%20%20%2F%2F%20do%20something%20with%20the%20elements%20of%20a%20house%0A%20%20%20%20house.accept(%26HouseElementDemolishVisitor%3A%3Anew())%3B%0A%7D">Run</a></pre></div>
<p>Base usage: RAII 模式</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="comment">/*
利用Rust的ownership（linear/affine type）来设计接口

存在的问题：

1. Letter有可能复制多份到多个信封（envelope）里，不安全
2. 信封里有可能有信，也有可能没有信；或者同一个信封装多次不同的信件，不安全
3. 有没有把信交给邮车也是无法保证，不安全

*/</span>

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Clone</span>)]</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">Letter</span> {
    <span class="ident">text</span>: <span class="ident">String</span>,
}
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">Envelope</span> {
    <span class="ident">letter</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">Letter</span><span class="op">&gt;</span>,
}
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">PickupLorryHandle</span> {
    <span class="ident">done</span>: <span class="ident">bool</span>,
}
<span class="kw">impl</span> <span class="ident">Letter</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">new</span>(<span class="ident">text</span>: <span class="ident">String</span>) <span class="op">-&gt;</span> <span class="self">Self</span> {
        <span class="ident">Letter</span> {<span class="ident">text</span>: <span class="ident">text</span>}
    }
}
<span class="kw">impl</span> <span class="ident">Envelope</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">wrap</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">letter</span>: <span class="kw-2">&amp;</span><span class="ident">Letter</span>){
        <span class="self">self</span>.<span class="ident">letter</span> <span class="op">=</span> <span class="prelude-val">Some</span>(<span class="ident">letter</span>.<span class="ident">clone</span>());
    }
}
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">buy_prestamped_envelope</span>() <span class="op">-&gt;</span> <span class="ident">Envelope</span> {
    <span class="ident">Envelope</span> {<span class="ident">letter</span>: <span class="prelude-val">None</span>}
}
<span class="kw">impl</span> <span class="ident">PickupLorryHandle</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">pickup</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">envelope</span>: <span class="kw-2">&amp;</span><span class="ident">Envelope</span>) {
        <span class="comment">/*give letter*/</span>
    }
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">done</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>) {
        <span class="self">self</span>.<span class="ident">done</span> <span class="op">=</span> <span class="bool-val">true</span>;
        <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;sent&quot;</span>);
    }
}
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">order_pickup</span>() <span class="op">-&gt;</span> <span class="ident">PickupLorryHandle</span> {
    <span class="ident">PickupLorryHandle</span> {<span class="ident">done</span>: <span class="bool-val">false</span> , <span class="comment">/* other handles */</span>}
}
<span class="kw">fn</span> <span class="ident">main</span>(){
    <span class="kw">let</span> <span class="ident">letter</span> <span class="op">=</span> <span class="ident">Letter</span>::<span class="ident">new</span>(<span class="ident">String</span>::<span class="ident">from</span>(<span class="string">&quot;Dear RustFest&quot;</span>));
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">envelope</span> <span class="op">=</span> <span class="ident">buy_prestamped_envelope</span>();
    <span class="ident">envelope</span>.<span class="ident">wrap</span>(<span class="kw-2">&amp;</span><span class="ident">letter</span>);
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">lorry</span> <span class="op">=</span> <span class="ident">order_pickup</span>();
    <span class="ident">lorry</span>.<span class="ident">pickup</span>(<span class="kw-2">&amp;</span><span class="ident">envelope</span>);
    <span class="ident">lorry</span>.<span class="ident">done</span>();
}

<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">builder_pattern</span>(){
    <span class="macro">unimplemented</span><span class="macro">!</span>();
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Ballow(unused)%5D%0A%2F*%0A%E5%88%A9%E7%94%A8Rust%E7%9A%84ownership%EF%BC%88linear%2Faffine%20type%EF%BC%89%E6%9D%A5%E8%AE%BE%E8%AE%A1%E6%8E%A5%E5%8F%A3%0A%0A%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%9A%0A%0A1.%20Letter%E6%9C%89%E5%8F%AF%E8%83%BD%E5%A4%8D%E5%88%B6%E5%A4%9A%E4%BB%BD%E5%88%B0%E5%A4%9A%E4%B8%AA%E4%BF%A1%E5%B0%81%EF%BC%88envelope%EF%BC%89%E9%87%8C%EF%BC%8C%E4%B8%8D%E5%AE%89%E5%85%A8%0A2.%20%E4%BF%A1%E5%B0%81%E9%87%8C%E6%9C%89%E5%8F%AF%E8%83%BD%E6%9C%89%E4%BF%A1%EF%BC%8C%E4%B9%9F%E6%9C%89%E5%8F%AF%E8%83%BD%E6%B2%A1%E6%9C%89%E4%BF%A1%EF%BC%9B%E6%88%96%E8%80%85%E5%90%8C%E4%B8%80%E4%B8%AA%E4%BF%A1%E5%B0%81%E8%A3%85%E5%A4%9A%E6%AC%A1%E4%B8%8D%E5%90%8C%E7%9A%84%E4%BF%A1%E4%BB%B6%EF%BC%8C%E4%B8%8D%E5%AE%89%E5%85%A8%0A3.%20%E6%9C%89%E6%B2%A1%E6%9C%89%E6%8A%8A%E4%BF%A1%E4%BA%A4%E7%BB%99%E9%82%AE%E8%BD%A6%E4%B9%9F%E6%98%AF%E6%97%A0%E6%B3%95%E4%BF%9D%E8%AF%81%EF%BC%8C%E4%B8%8D%E5%AE%89%E5%85%A8%0A%0A*%2F%0A%0A%23%5Bderive(Clone)%5D%0Apub%20struct%20Letter%20%7B%0A%20%20%20%20text%3A%20String%2C%0A%7D%0Apub%20struct%20Envelope%20%7B%0A%20%20%20%20letter%3A%20Option%3CLetter%3E%2C%0A%7D%0Apub%20struct%20PickupLorryHandle%20%7B%0A%20%20%20%20done%3A%20bool%2C%0A%7D%0Aimpl%20Letter%20%7B%0A%20%20%20%20pub%20fn%20new(text%3A%20String)%20-%3E%20Self%20%7B%0A%20%20%20%20%20%20%20%20Letter%20%7Btext%3A%20text%7D%0A%20%20%20%20%7D%0A%7D%0Aimpl%20Envelope%20%7B%0A%20%20%20%20pub%20fn%20wrap(%26mut%20self%2C%20letter%3A%20%26Letter)%7B%0A%20%20%20%20%20%20%20%20self.letter%20%3D%20Some(letter.clone())%3B%0A%20%20%20%20%7D%0A%7D%0Apub%20fn%20buy_prestamped_envelope()%20-%3E%20Envelope%20%7B%0A%20%20%20%20Envelope%20%7Bletter%3A%20None%7D%0A%7D%0Aimpl%20PickupLorryHandle%20%7B%0A%20%20%20%20pub%20fn%20pickup(%26mut%20self%2C%20envelope%3A%20%26Envelope)%20%7B%0A%20%20%20%20%20%20%20%20%2F*give%20letter*%2F%0A%20%20%20%20%7D%0A%20%20%20%20pub%20fn%20done(%26mut%20self)%20%7B%0A%20%20%20%20%20%20%20%20self.done%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20println!(%22sent%22)%3B%0A%20%20%20%20%7D%0A%7D%0Apub%20fn%20order_pickup()%20-%3E%20PickupLorryHandle%20%7B%0A%20%20%20%20PickupLorryHandle%20%7Bdone%3A%20false%20%2C%20%2F*%20other%20handles%20*%2F%7D%0A%7D%0Afn%20main()%7B%0A%20%20%20%20let%20letter%20%3D%20Letter%3A%3Anew(String%3A%3Afrom(%22Dear%20RustFest%22))%3B%0A%20%20%20%20let%20mut%20envelope%20%3D%20buy_prestamped_envelope()%3B%0A%20%20%20%20envelope.wrap(%26letter)%3B%0A%20%20%20%20let%20mut%20lorry%20%3D%20order_pickup()%3B%0A%20%20%20%20lorry.pickup(%26envelope)%3B%0A%20%20%20%20lorry.done()%3B%0A%7D%0A%0Apub%20fn%20builder_pattern()%7B%0A%20%20%20%20unimplemented!()%3B%0A%7D">Run</a></pre></div>
<p>Base usage: 【重构】RAII 模式</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="comment">/*
利用Rust的ownership（linear/affine type）来设计接口

Refact

1. 去掉letter的Clone，使用所有权保证其唯一性；并且信封的wrap方法只接受获得所有权的信封，而非引用
2. 使用类型系统来保证信封的唯一性
3. 使用RAII机制来管理收尾逻辑，比如实现Drop

其他示例：

1. http response
2. steaming engine

*/</span>

<span class="comment">// #[derive(Clone)]</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">Letter</span> {
    <span class="ident">text</span>: <span class="ident">String</span>,
}
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">EmptyEnvelope</span> {}
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">ClosedEnvelope</span> {
    <span class="ident">letter</span>: <span class="ident">Letter</span>,
}
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">PickupLorryHandle</span> {
    <span class="ident">done</span>: <span class="ident">bool</span>,
}
<span class="kw">impl</span> <span class="ident">Letter</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">new</span>(<span class="ident">text</span>: <span class="ident">String</span>) <span class="op">-&gt;</span> <span class="self">Self</span> {
        <span class="ident">Letter</span> {<span class="ident">text</span>: <span class="ident">text</span>}
    }
}
<span class="kw">impl</span> <span class="ident">EmptyEnvelope</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">wrap</span>(<span class="self">self</span>, <span class="ident">letter</span>: <span class="ident">Letter</span>) <span class="op">-&gt;</span> <span class="ident">ClosedEnvelope</span> {
        <span class="ident">ClosedEnvelope</span> {<span class="ident">letter</span>: <span class="ident">letter</span>}
    }
}
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">buy_prestamped_envelope</span>() <span class="op">-&gt;</span> <span class="ident">EmptyEnvelope</span> {
    <span class="ident">EmptyEnvelope</span> {}
}
<span class="kw">impl</span> <span class="ident">PickupLorryHandle</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">pickup</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">envelope</span>: <span class="ident">ClosedEnvelope</span>) {
        <span class="comment">/*give letter*/</span>
    }
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">done</span>(<span class="self">self</span>) {}
}
<span class="kw">impl</span> <span class="ident">Drop</span> <span class="kw">for</span> <span class="ident">PickupLorryHandle</span> {
    <span class="kw">fn</span> <span class="ident">drop</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>) {
        <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;sent&quot;</span>);
    }
}
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">order_pickup</span>() <span class="op">-&gt;</span> <span class="ident">PickupLorryHandle</span> {
    <span class="ident">PickupLorryHandle</span> {<span class="ident">done</span>: <span class="bool-val">false</span> , <span class="comment">/* other handles */</span>}
}
<span class="kw">fn</span> <span class="ident">main</span>(){
    <span class="kw">let</span> <span class="ident">letter</span> <span class="op">=</span> <span class="ident">Letter</span>::<span class="ident">new</span>(<span class="ident">String</span>::<span class="ident">from</span>(<span class="string">&quot;Dear RustFest&quot;</span>));
    <span class="kw">let</span> <span class="ident">envelope</span> <span class="op">=</span> <span class="ident">buy_prestamped_envelope</span>();
    <span class="kw">let</span> <span class="ident">closed_envelope</span> <span class="op">=</span> <span class="ident">envelope</span>.<span class="ident">wrap</span>(<span class="ident">letter</span>);
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">lorry</span> <span class="op">=</span> <span class="ident">order_pickup</span>();
    <span class="ident">lorry</span>.<span class="ident">pickup</span>(<span class="ident">closed_envelope</span>);
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Ballow(unused)%5D%0A%2F*%0A%E5%88%A9%E7%94%A8Rust%E7%9A%84ownership%EF%BC%88linear%2Faffine%20type%EF%BC%89%E6%9D%A5%E8%AE%BE%E8%AE%A1%E6%8E%A5%E5%8F%A3%0A%0ARefact%0A%0A1.%20%E5%8E%BB%E6%8E%89letter%E7%9A%84Clone%EF%BC%8C%E4%BD%BF%E7%94%A8%E6%89%80%E6%9C%89%E6%9D%83%E4%BF%9D%E8%AF%81%E5%85%B6%E5%94%AF%E4%B8%80%E6%80%A7%EF%BC%9B%E5%B9%B6%E4%B8%94%E4%BF%A1%E5%B0%81%E7%9A%84wrap%E6%96%B9%E6%B3%95%E5%8F%AA%E6%8E%A5%E5%8F%97%E8%8E%B7%E5%BE%97%E6%89%80%E6%9C%89%E6%9D%83%E7%9A%84%E4%BF%A1%E5%B0%81%EF%BC%8C%E8%80%8C%E9%9D%9E%E5%BC%95%E7%94%A8%0A2.%20%E4%BD%BF%E7%94%A8%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E6%9D%A5%E4%BF%9D%E8%AF%81%E4%BF%A1%E5%B0%81%E7%9A%84%E5%94%AF%E4%B8%80%E6%80%A7%0A3.%20%E4%BD%BF%E7%94%A8RAII%E6%9C%BA%E5%88%B6%E6%9D%A5%E7%AE%A1%E7%90%86%E6%94%B6%E5%B0%BE%E9%80%BB%E8%BE%91%EF%BC%8C%E6%AF%94%E5%A6%82%E5%AE%9E%E7%8E%B0Drop%0A%0A%E5%85%B6%E4%BB%96%E7%A4%BA%E4%BE%8B%EF%BC%9A%0A%0A1.%20http%20response%0A2.%20steaming%20engine%0A%0A*%2F%0A%0A%2F%2F%20%23%5Bderive(Clone)%5D%0Apub%20struct%20Letter%20%7B%0A%20%20%20%20text%3A%20String%2C%0A%7D%0Apub%20struct%20EmptyEnvelope%20%7B%7D%0Apub%20struct%20ClosedEnvelope%20%7B%0A%20%20%20%20letter%3A%20Letter%2C%0A%7D%0Apub%20struct%20PickupLorryHandle%20%7B%0A%20%20%20%20done%3A%20bool%2C%0A%7D%0Aimpl%20Letter%20%7B%0A%20%20%20%20pub%20fn%20new(text%3A%20String)%20-%3E%20Self%20%7B%0A%20%20%20%20%20%20%20%20Letter%20%7Btext%3A%20text%7D%0A%20%20%20%20%7D%0A%7D%0Aimpl%20EmptyEnvelope%20%7B%0A%20%20%20%20pub%20fn%20wrap(self%2C%20letter%3A%20Letter)%20-%3E%20ClosedEnvelope%20%7B%0A%20%20%20%20%20%20%20%20ClosedEnvelope%20%7Bletter%3A%20letter%7D%0A%20%20%20%20%7D%0A%7D%0Apub%20fn%20buy_prestamped_envelope()%20-%3E%20EmptyEnvelope%20%7B%0A%20%20%20%20EmptyEnvelope%20%7B%7D%0A%7D%0Aimpl%20PickupLorryHandle%20%7B%0A%20%20%20%20pub%20fn%20pickup(%26mut%20self%2C%20envelope%3A%20ClosedEnvelope)%20%7B%0A%20%20%20%20%20%20%20%20%2F*give%20letter*%2F%0A%20%20%20%20%7D%0A%20%20%20%20pub%20fn%20done(self)%20%7B%7D%0A%7D%0Aimpl%20Drop%20for%20PickupLorryHandle%20%7B%0A%20%20%20%20fn%20drop(%26mut%20self)%20%7B%0A%20%20%20%20%20%20%20%20println!(%22sent%22)%3B%0A%20%20%20%20%7D%0A%7D%0Apub%20fn%20order_pickup()%20-%3E%20PickupLorryHandle%20%7B%0A%20%20%20%20PickupLorryHandle%20%7Bdone%3A%20false%20%2C%20%2F*%20other%20handles%20*%2F%7D%0A%7D%0Afn%20main()%7B%0A%20%20%20%20let%20letter%20%3D%20Letter%3A%3Anew(String%3A%3Afrom(%22Dear%20RustFest%22))%3B%0A%20%20%20%20let%20envelope%20%3D%20buy_prestamped_envelope()%3B%0A%20%20%20%20let%20closed_envelope%20%3D%20envelope.wrap(letter)%3B%0A%20%20%20%20let%20mut%20lorry%20%3D%20order_pickup()%3B%0A%20%20%20%20lorry.pickup(closed_envelope)%3B%0A%7D">Run</a></pre></div>
</div></section><section id="search" class="content hidden"></section><section class="footer"></section><aside id="help" class="hidden"><div><h1 class="hidden">Help</h1><div class="shortcuts"><h2>Keyboard Shortcuts</h2><dl><dt><kbd>?</kbd></dt><dd>Show this help dialog</dd><dt><kbd>S</kbd></dt><dd>Focus the search field</dd><dt><kbd>↑</kbd></dt><dd>Move up in search results</dd><dt><kbd>↓</kbd></dt><dd>Move down in search results</dd><dt><kbd>↹</kbd></dt><dd>Switch tab</dd><dt><kbd>&#9166;</kbd></dt><dd>Go to active search result</dd><dt><kbd>+</kbd></dt><dd>Expand all sections</dd><dt><kbd>-</kbd></dt><dd>Collapse all sections</dd></dl></div><div class="infos"><h2>Search Tricks</h2><p>Prefix searches with a type followed by a colon (e.g. <code>fn:</code>) to restrict the search to a given type.</p><p>Accepted types are: <code>fn</code>, <code>mod</code>, <code>struct</code>, <code>enum</code>, <code>trait</code>, <code>type</code>, <code>macro</code>, and <code>const</code>.</p><p>Search functions by type signature (e.g. <code>vec -> usize</code> or <code>* -> vec</code>)</p><p>Search multiple things at once by splitting your query with comma (e.g. <code>str,u8</code> or <code>String,struct:Vec,test</code>)</p></div></div></aside><script>window.rootPath = "../../../";window.currentCrate = "tao_of_rust";</script><script src="../../../aliases.js"></script><script src="../../../main.js"></script><script defer src="../../../search-index.js"></script></body></html>